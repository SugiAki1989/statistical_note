---
title: 'Rstanの基礎の基礎'
pagetitle: 'Rstanの基礎の基礎'
output:
  html_document:
    toc: TRUE
    toc_depth: 5
    toc_float: FALSE
    # number_sections: TRUE
    code_folding: 'show'
    highlight: 'kate'
    # theme: 'flatly'
    css: ../style.css
    md_extensions: -ascii_identifiers
---

```{r SETUP, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  # out.width = 800,
  # out.height = 600,
  fig.align = 'center',
  dev = 'ragg_png'
)
```

<div class='update-right'>
UPDATE: `r Sys.time()`
</div>

# はじめに

このノートでは、2015年以来8年ぶりにベイズ統計学を再学習し始めたので、このノートではRStanの基礎まで戻って使い方をまとめている。RStanの使い方が中心なので、数理的な部分はまとめていません。[標準ベイズ統計学](https://www.asakura.co.jp/detail.php?book_code=12267)などを参照願います。

## RStanの準備

RからStanを実行するためには`rstan`パッケージが必要なので、インストールして読み込んでおく。

```{r}
library(bayesplot)
library(rstan)
rstan_options(auto_write = TRUE)
# プログラム変更がない限り再コンパイルをしない設定
options(mc.cores = parallel::detectCores())
packageVersion('rstan')
```

StanはC++で動くので、C++コンパイラがインストールされているかチェックしたい場合は下記を実行する。

```{r}
pkgbuild::has_build_tools(debug = TRUE)
```


## 推定モデルの構造

ここで扱うモデルは下記の通り非常にシンプルなもの。$y$は正規分布$Normal(\mu, \sigma)$に従って発生すると仮定したモデルを仮定する。

$$
y \sim Normal(\mu, \sigma)
$$

データは予め平均100、標準偏差5の正規分布として生成しておく。図解すると下記のようなデータ生成仮定をイメージしている。何らかのスカラ値である$\mu,\sigma$から各$y_{1...N}$は生成されているというイメージである。

```{r}
set.seed(1989)
y <- rnorm(50, 100, 5)
# head(y)
# [1] 105.51289 105.58948  90.90949  99.02793  96.93402  98.26866
# 
# 105.51289 ~ Normal(mu, sigma)
# 105.58948 ~ Normal(mu, sigma)
#  90.90949 ~ Normal(mu, sigma)
#  99.02793 ~ Normal(mu, sigma)
#  96.93402 ~ Normal(mu, sigma)
# ...
#  y_50     ~ Normal(mu, sigma)
```

モデルの構造が決まったらStanファイルを用意する。Stanファイルには役割を持つブロックごとに必要は情報を記載する。

```
data {
  // 使用するデータやベクトルや行列の定義を行う
}
transformed data{
  // dataで定義された変数に何らかの変換を加える場合に記載
}
parameters {
  // 事後分布として得たいパラメタを記載する
}
transformed parameters {
  // parametersで定義された変数に何らかの変換を加える場合に記載
}
model {
  // モデル式を記述す
}
generated quantities{
  // サンプリングで得られたパラメタをから何らかの計算を加える場合記載
  // サンプリングでされたパラメタで、事後分布に従う乱数を生成する場合など
}
```

ということで、今回想定しているモデルを推定するためにStanファイルを作成する。`model`ブロックを見ればわかる通り、$y_{1...N}$は正規分布$Normal(\mu, \sigma)$に従って発生すると仮定するモデルをここでは利用する。

```
data {
  int N;       // Sample size
  real y[N]; // Data
}
parameters {
  real mu;             
  real<lower=0> sigma; // not sigma2
}
model {
  // vector version
  // y ~ normal(mu, sigma);
  // for-loop version
  for(i in 1:N){
    y[i] ~ normal(mu, sigma);
  }
}
generated quantities{
  // Posterior Predictive Distribution
  real pred[N];
  
  for(i in 1:N){
    pred[i] = normal_rng(mu, sigma);
  }
}
```

## モデルを推定する

Stanファイルが準備できれば、MCMCを実行するために必要な情報をまとめる。今回は、チェーンは2、イテレーションは2000、バーンイン期間は1000、間引きなしという設定なので、2000-1000=1000が乱数として得られる。

```{r}
datas <- list(y = y, N = length(y))
result <- stan(
  file = 'note_bayes02.stan',
  data = datas,
  seed = 1989,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  thin = 1 # 間引かない
)
```

サンプリングされた平均、標準偏差の事後分布の値を確認すると、上手く推定できている(とする)。

```{r}
print(
  result, 
  probs = c(0.025, 0.5, 0.975)
)
```

`Rhat=1`なので、トレースプロットを見なくても収束しているとわかる。

```{r}
traceplot(result, inc_warmup = FALSE)
```

事後分布を可視化する場合、`bayesplot`パッケージの関数群が便利。事後分布のヒストグラムを確認したいのであれば`mcmc_hist()`関数にサンプリング結果を渡せば良い。他にも`mcmc_dens()`関数、`mcmc_trace`関数、`mcmc_combo`関数、`mcmc_intervals()`関数、`mcmc_acf_bar()`関数が用意されている。

```{r}
mcmc_hist(result)
```

## モデルの事後予測を確認する

モデルの良し悪しの確認として、モデルがデータと適合している度合いをみる。統計モデルは「観測データの生成過程を表現する」ために用いられる。つまり、妥当な統計モデルが得られているのであれば、その統計モデルは「観測データと類似するデータを生成できる」はず。事後予測分布と観測データが似ているのであれば、良いモデルが得られていると考えることができる。

事後予測分布$f(pred | y) $は下記のとおり定義される。$f(pred | \theta)$はモデルの確率密度関数で、$f(\theta|y)$は事後分布である。

$$
f(pred | y) = \int f(pred | \theta) f(\theta|y) d\theta
$$

簡単には計算できないものの、`generated quantities`ブロックで記述することで得られる。

```
generated quantities{
  // Posterior Predictive Distribution
  real pred;
  pred = normal_rng(mu, sigma);
}

```

やっていることは、$\theta$のMCMCサンプルが得られているので、$\theta$のMCMCサンプルをパラメタとして、正規分布に従う乱数を得る。これが`pred`のMCMCサンプルになる。

MCMCから得られたサンプルを取り出すためには`extract()`関数を利用する。`pred`は4000行500列となっているが、元々`y`のサンプルサイズは500だったので、イテレーション2000からバーンイン1000を引いて、1チェイン1000が4本で4000個のMCMCサンプルという意味なので、このセットが500個存在していることを意味する。

```{r}
mcmc_pred <- rstan::extract(result)$pred
dim(mcmc_pred)
```


```{r}
ppc_hist(
  y = y,
  yrep = mcmc_pred
)
```

## 参考文献

- [Stan Reference Manual](https://mc-stan.org/docs/reference-manual/index.html)